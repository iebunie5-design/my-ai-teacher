<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>My AI Teacher - Vercel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.0/build/stlite.css" />
</head>

<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.0/build/stlite.js"></script>
  <script>
    stlite.mount(
      {
        requirements: ["requests", "gTTS", "streamlit-mic-recorder"],
        entrypoint: "app_vercel.py",
        files: {
          "app_vercel.py": `import streamlit as st
import requests
import json
from gtts import gTTS
import io
from streamlit_mic_recorder import mic_recorder

st.set_page_config(page_title="My AI Teacher", page_icon="ğŸ“", layout="centered")

st.markdown("""
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
    [data-testid="stAppViewContainer"] { background-color: #ffffff; font-family: 'Inter', sans-serif; }
    .app-header { text-align: center; padding: 2rem 0; border-bottom: 1px solid #f1f5f9; margin-bottom: 2rem; }
    .app-header h1 { font-family: 'Outfit', sans-serif; font-size: 1.8rem; color: #0f172a; margin: 0; }
    [data-testid="stSidebar"] { background-color: #f8fafc; border-right: 1px solid #e2e8f0; }
    .stChatInputContainer { border-radius: 16px !important; box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important; }
    </style>
    <div class="app-header">
        <h1>ğŸ“ My AI Teacher</h1>
        <p>Vercel Serverless Edition</p>
    </div>
    """, unsafe_allow_html=True)

if "messages" not in st.session_state: st.session_state.messages = []
if "history" not in st.session_state: st.session_state.history = []

with st.sidebar:
    st.markdown("### âš™ï¸ Settings")
    api_key = st.text_input("Gemini API Key", type="password")
    level = st.selectbox("Your Level", ["ì´ˆê¸‰", "ì¤‘ê¸‰", "ê³ ê¸‰"])
    topic = st.selectbox("Topic", ["ìê¸°ì†Œê°œ", "ì—¬í–‰", "ì‡¼í•‘", "ìŒì‹ì ", "ì§ì¥ìƒí™œ"])
    if st.button("ğŸ”„ Start New Session"):
        st.session_state.messages = []; st.session_state.history = []; st.rerun()

def call_gemini_api(prompt, api_key):
    # API ë²„ì „ì„ v1ìœ¼ë¡œ ë³€ê²½í•˜ê³  ëª¨ë¸ëª…ì„ gemini-1.5-flashë¡œ í†µì¼í–ˆìŠµë‹ˆë‹¤.
    url = f"https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}"
    headers = {'Content-Type': 'application/json'}
    contents = st.session_state.history + [{"role": "user", "parts": [{"text": prompt}]}]
    data = {"contents": contents}
    try:
        response = requests.post(url, headers=headers, data=json.dumps(data))
        if response.status_code == 200:
            result = response.json()
            ai_text = result['candidates'][0]['content']['parts'][0]['text']
            st.session_state.history.append({"role": "user", "parts": [{"text": prompt}]})
            st.session_state.history.append({"role": "model", "parts": [{"text": ai_text}]})
            return ai_text
        return f"Error: {response.text}"
    except Exception as e:
        return f"Request Error: {e}"

def text_to_speech(text):
    main_text = text.split('\\n')[0]
    try:
        tts = gTTS(text=main_text, lang='en')
        fp = io.BytesIO()
        tts.write_to_fp(fp)
        return fp
    except: return None

if not api_key:
    st.info("ì‚¬ì´ë“œë°”ì— API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    st.stop()

if not st.session_state.messages:
    system_instruction = f"You are a friendly English teacher. Student: {level}, Topic: {topic}. Start the conversation warmly."
    ai_greeting = call_gemini_api(system_instruction, api_key)
    if "Error" not in ai_greeting:
        st.session_state.messages.append({"role": "assistant", "content": ai_greeting})
    else:
        st.error(ai_greeting)

for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])
        if msg["role"] == "assistant":
            audio_fp = text_to_speech(msg["content"])
            if audio_fp: st.audio(audio_fp, format="audio/mp3")

text_input = st.chat_input("Say something...")
if text_input:
    st.session_state.messages.append({"role": "user", "content": text_input})
    with st.chat_message("assistant"):
        ai_res = call_gemini_api(text_input, api_key)
        st.markdown(ai_res)
        audio_fp = text_to_speech(ai_res)
        if audio_fp: st.audio(audio_fp, format="audio/mp3")
        st.session_state.messages.append({"role": "assistant", "content": ai_res})
        st.rerun()`
        },
      },
      document.getElementById("root")
    );
  </script>
</body>

</html>